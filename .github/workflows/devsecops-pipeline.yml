# Complete DevSecOps CI/CD Pipeline for Tic-Tac-Toe App
name: DevSecOps Pipeline
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/tictactoe-app
  DOCKER_TAG: ${{ github.sha }}
  EC2_HOST: ${{ secrets.EC2_HOST }}
  APP_PORT: 3000

jobs:
  # =============================================
  # JOB 1: Secrets Detection (GitLeaks)
  # =============================================
  secrets-scan:
    name: Secrets Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # =============================================
  # JOB 2: Dependency Vulnerability Scan (SCA)
  # =============================================
  dependency-scan:
    name: Dependency Audit (npm + OWASP DC)
    runs-on: ubuntu-latest
    needs: secrets-scan
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: npm audit (fail on high/critical)
        run: npm audit --audit-level=high
      - name: OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: tictactoe-app
          path: .
          format: HTML
          args: >
            --failOnCVSS 7
            --enableRetired
      - name: Upload OWASP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dependency-report
          path: reports/

  # =============================================
  # JOB 3: SAST - ESLint + SonarQube
  # =============================================
  sast-scan:
    name: SAST (ESLint + SonarQube)
    runs-on: ubuntu-latest
    needs: secrets-scan
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run ESLint (SAST)
        run: npx eslint . --format json --output-file eslint-report.json || true
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      - name: Upload ESLint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-report
          path: eslint-report.json

  # =============================================
  # JOB 4: Unit Tests
  # =============================================
  unit-tests:
    name: Unit Tests (Vitest)
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast-scan]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run Tests with Coverage
        run: npx vitest run --coverage
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/

  # =============================================
  # JOB 5: Docker Build + Trivy Container Scan
  # =============================================
  docker-build-scan:
    name: Docker Build & Trivy Scan
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker Image
        run: |
          docker build -t $DOCKER_IMAGE:$DOCKER_TAG .
          docker tag $DOCKER_IMAGE:$DOCKER_TAG $DOCKER_IMAGE:latest
      - name: Trivy - Scan for CRITICAL/HIGH CVEs
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
          format: table
          exit-code: 1
          ignore-unfixed: true
          vuln-type: os,library
          severity: CRITICAL,HIGH
      - name: Trivy SARIF Report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
          format: sarif
          output: trivy-results.sarif
      - name: Upload Trivy Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-report
          path: trivy-results.sarif
      - name: Login to Docker Hub
        if: success()
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Push Docker Image
        if: success()
        run: |
          docker push $DOCKER_IMAGE:$DOCKER_TAG
          docker push $DOCKER_IMAGE:latest

  # =============================================
  # JOB 6: Deploy to EC2 via SSH
  # =============================================
  deploy-to-ec2:
    name: Deploy to EC2 (Docker)
    runs-on: ubuntu-latest
    needs: docker-build-scan
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker pull ${{ env.DOCKER_IMAGE }}:latest
            docker stop tictactoe || true
            docker rm tictactoe || true
            docker run -d \
              --name tictactoe \
              --restart unless-stopped \
              -p 80:80 \
              ${{ env.DOCKER_IMAGE }}:latest
            docker ps | grep tictactoe

  # =============================================
  # JOB 7: DAST - OWASP ZAP Scan
  # =============================================
  dast-scan:
    name: DAST (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: deploy-to-ec2
    steps:
      - uses: actions/checkout@v4
      - name: Wait for app to be ready
        run: sleep 30
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: http://${{ secrets.EC2_HOST }}
          rules_file_name: .zap/rules.tsv
          cmd_options: -a -j
          fail_action: true
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report
          path: report_html.html

  # =============================================
  # JOB 8: Slack Notification (Always runs)
  # =============================================
  slack-notify:
    name: Slack Notification
    runs-on: ubuntu-latest
    needs: [secrets-scan, dependency-scan, sast-scan, unit-tests,
            docker-build-scan, deploy-to-ec2, dast-scan]
    if: always()
    steps:
      - name: Get Pipeline Status
        id: pipeline-status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "STATUS=FAILED" >> $GITHUB_OUTPUT
            echo "COLOR=danger" >> $GITHUB_OUTPUT
            echo "EMOJI=:x:" >> $GITHUB_OUTPUT
          elif [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "STATUS=CANCELLED" >> $GITHUB_OUTPUT
            echo "COLOR=warning" >> $GITHUB_OUTPUT
            echo "EMOJI=:warning:" >> $GITHUB_OUTPUT
          else
            echo "STATUS=SUCCESS" >> $GITHUB_OUTPUT
            echo "COLOR=good" >> $GITHUB_OUTPUT
            echo "EMOJI=:white_check_mark:" >> $GITHUB_OUTPUT
          fi
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.pipeline-status.outputs.COLOR }}",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "${{ steps.pipeline-status.outputs.EMOJI }} DevSecOps Pipeline ${{ steps.pipeline-status.outputs.STATUS }}"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {"type":"mrkdwn","text":"*Repo:*\n${{ github.repository }}"},
                        {"type":"mrkdwn","text":"*Branch:*\n${{ github.ref_name }}"},
                        {"type":"mrkdwn","text":"*Commit:*\n${{ github.sha }}"},
                        {"type":"mrkdwn","text":"*Triggered by:*\n${{ github.actor }}"},
                        {"type":"mrkdwn","text":"*Secrets Scan:*\n${{ needs.secrets-scan.result }}"},
                        {"type":"mrkdwn","text":"*Dependency Scan:*\n${{ needs.dependency-scan.result }}"},
                        {"type":"mrkdwn","text":"*SAST (SonarQube):*\n${{ needs.sast-scan.result }}"},
                        {"type":"mrkdwn","text":"*Unit Tests:*\n${{ needs.unit-tests.result }}"},
                        {"type":"mrkdwn","text":"*Container Scan (Trivy):*\n${{ needs.docker-build-scan.result }}"},
                        {"type":"mrkdwn","text":"*Deployment:*\n${{ needs.deploy-to-ec2.result }}"},
                        {"type":"mrkdwn","text":"*DAST (OWASP ZAP):*\n${{ needs.dast-scan.result }}"}
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {"type": "plain_text", "text": "View Pipeline"},
                          "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
